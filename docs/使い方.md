# Walleca 使い方ガイド

このドキュメントでは、Walleca プロジェクトの環境構築・開発サーバー起動・テスト実行・その他の運用方法を説明します。

---

## 1. プロジェクト構成

```
Walleca/
├── api/          # バックエンド API（Node.js + Express + Prisma）
├── web/          # フロントエンド（Next.js）
├── docker/       # Docker 関連
├── nginx/        # リバースプロキシ設定
├── docs/         # ドキュメント
└── docker-compose.yml  # PostgreSQL・Redis のコンテナ定義
```

- **api**: REST API サーバー。認証・レシート・取引・サブスク・通知などの機能を提供。
- **web**: ブラウザ用の Next.js アプリ。API と通信して画面を表示。

---

## 2. 前提条件

- **Node.js**: 20.x 以上（api の engines に準拠）
- **npm**: 9.x 以上を推奨
- **Docker / Docker Compose**: 開発用 DB（PostgreSQL）と Redis の起動に使用
- **pnpm / yarn**: 利用する場合は各パッケージマネージャーの手順に読み替えてください

---

## 3. 環境構築

### 3.1 リポジトリのクローンと依存関係インストール

```bash
# リポジトリのルートで
cd /path/to/Walleca

# API の依存関係
cd api && npm install && cd ..

# Web の依存関係
cd web && npm install && cd ..
```

### 3.2 Docker で PostgreSQL と Redis を起動

開発用のデータベースと Redis は Docker Compose で起動します。

```bash
# プロジェクトルートで
docker-compose up -d

# 起動確認（postgres, redis が healthy になるまで待つ）
docker-compose ps
```

- **PostgreSQL**: `localhost:5432`（ユーザー: `walleca`, DB: `walleca`, パスワード: `docker-compose.yml` 参照）
- **Redis**: `localhost:6379`

### 3.3 環境変数の設定

#### API（api/.env）

`api/.env.example` をコピーして `api/.env` を作成し、必要に応じて値を編集します。

```bash
cp api/.env.example api/.env
```

主な項目:

| 変数名 | 説明 | 開発時の例 |
|--------|------|------------|
| `DATABASE_URL` | PostgreSQL 接続文字列 | `postgresql://walleca:walleca_dev_password@localhost:5432/walleca` |
| `REDIS_URL` | Redis 接続 URL | `redis://localhost:6379` |
| `JWT_SECRET` | JWT 署名用シークレット（32文字以上推奨） | 任意の長い文字列 |
| `JWT_REFRESH_SECRET` | リフレッシュトークン用シークレット | 任意の長い文字列 |
| `PORT` | API サーバーのポート | `3000` |
| `UPLOAD_DIR` | アップロードファイル保存先 | `./uploads` |

`docker-compose.yml` のパスワードは `walleca_dev_password` なので、開発時は次のようにするとよいです。

```
DATABASE_URL=postgresql://walleca:walleca_dev_password@localhost:5432/walleca
REDIS_URL=redis://localhost:6379
```

#### Web（web/.env.local）

`web/.env.example` をコピーして `web/.env.local` を作成します。

```bash
cp web/.env.example web/.env.local
```

| 変数名 | 説明 |
|--------|------|
| `NEXT_PUBLIC_API_URL` | フロントから叩く API のベース URL（例: `/api` またはプロキシ先の URL） |

### 3.4 データベースのマイグレーション（API）

API で Prisma を使っているため、初回またはスキーマ変更後にマイグレーションを実行します。

```bash
cd api
npm run db:migrate
```

必要に応じてシードデータを投入する場合（シードスクリプトがある場合）:

```bash
npm run db:seed
```

---

## 4. 開発サーバーの起動

### 4.1 API サーバー

```bash
cd api
npm run dev
```

- デフォルトでは `PORT` で指定したポート（例: 3000）で起動します。
- `tsx watch` によりファイル変更で自動リロードされます。

### 4.2 Web（Next.js）

別ターミナルで:

```bash
cd web
npm run dev
```

- 通常は `http://localhost:3000`（Next.js のデフォルト）でアクセスします。API が 3000 の場合は Next が 3001 など別ポートを使う場合があります。起動ログを確認してください。

### 4.3 ワーカー（オプション）

レシート OCR や通知など、キューを処理するワーカーを動かす場合:

```bash
cd api
# 全ワーカー
npm run worker

# OCR ワーカーのみ
npm run worker:ocr

# 通知ワーカーのみ
npm run worker:notification
```

Redis が起動している必要があります。

---

## 5. テストの実行方法

### 5.1 API（Jest）

API にはテスト用のスクリプトとディレクトリ構成が用意されています。

- **単体テスト**: `api/tests/unit/`（`services/`, `utils/` など）
- **結合テスト**: `api/tests/integration/`
- **E2E テスト**: `api/tests/e2e/`

**テストの実行:**

```bash
cd api
npm test
```

**ウォッチモード（変更のたびに再実行）:**

```bash
npm run test:watch
```

**注意**: 現時点で Jest が `package.json` の devDependencies に含まれていない場合は、以下でセットアップできます。

```bash
cd api
npm install -D jest ts-jest @types/jest
```

その後、`api/jest.config.js` を用意する例（TypeScript 用）:

```js
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'node',
  roots: ['<rootDir>/tests'],
  testMatch: ['**/*.test.ts', '**/*.spec.ts'],
  moduleFileExtensions: ['ts', 'js', 'json'],
  collectCoverageFrom: ['src/**/*.ts', '!src/**/*.d.ts'],
};
```

テスト実行前に PostgreSQL や Redis が必要な場合は、Docker Compose を起動した状態で行ってください。結合テスト・E2E では、テスト用の DB や環境変数（例: `DATABASE_URL`）を分ける運用も検討してください。

### 5.2 Web（フロントエンド）

現時点では `web/package.json` にテスト用スクリプトは定義されていません。  
Jest（React Testing Library）や Vitest などを導入する場合は、次のようなコマンドを追加できます。

- 例: `"test": "vitest"`, `"test:run": "vitest run"`

テスト導入後は、ここに実行方法（例: `cd web && npm test`）を追記するとよいです。

---

## 6. その他のよく使うコマンド

### 6.1 API（api/）

| コマンド | 説明 |
|----------|------|
| `npm run build` | TypeScript をビルド（`dist/` に出力） |
| `npm start` | ビルド済み `dist/index.js` を実行（本番用） |
| `npm run db:migrate` | Prisma マイグレーション実行 |
| `npm run db:push` | スキーマを DB に反映（プロトタイプ向け） |
| `npm run db:studio` | Prisma Studio を起動（DB の GUI 確認） |
| `npm run lint` | ESLint で `src` をチェック |
| `npm run typecheck` | `tsc --noEmit` で型チェック |

### 6.2 Web（web/）

| コマンド | 説明 |
|----------|------|
| `npm run build` | Next.js の本番ビルド |
| `npm start` | ビルド後の本番モード起動 |
| `npm run lint` | ESLint でプロジェクトをチェック |
| `npm run typecheck` | `tsc --noEmit` で型チェック |

---

## 7. トラブルシューティング

- **API に接続できない**: `api/.env` の `PORT` と、Web の `NEXT_PUBLIC_API_URL` が一致しているか確認してください。CORS の設定も確認してください。
- **DB に接続できない**: `docker-compose up -d` で PostgreSQL が起動しているか、`DATABASE_URL` のホスト・ポート・ユーザー・パスワードが正しいか確認してください。
- **マイグレーションエラー**: `api/prisma/schema.prisma` と DB の状態が食い違っていないか確認し、必要に応じて `db:migrate` や `db:push` を再実行してください。
- **ワーカーが動かない**: Redis が起動しているか、`REDIS_URL` が正しいか確認してください。

---

## 8. 関連ドキュメント

- [要件定義書](./要件定義書.md) … 背景・目的・機能要件
- [設計書](./設計書.md) … アーキテクチャ・DB 設計・API 設計

以上が、Walleca の環境構築からテストまでの使い方の概要です。
