generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ユーザー
model User {
  id           String   @id @default(uuid()) @db.Uuid
  email        String   @unique @db.VarChar(255)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  displayName  String   @map("display_name") @db.VarChar(100)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz

  receipts      Receipt[]
  transactions  Transaction[]
  subscriptions Subscription[]
  views         View[]
  notifications Notification[]
  refreshTokens RefreshToken[]

  @@map("users")
}

// OCRステータス
enum OcrStatus {
  pending
  processing
  success
  failed

  @@map("ocr_status")
}

// レシート
model Receipt {
  id                String    @id @default(uuid()) @db.Uuid
  userId            String    @map("user_id") @db.Uuid
  imagePath         String    @map("image_path") @db.VarChar(500)
  imageSize         Int       @map("image_size")
  mimeType          String    @map("mime_type") @db.VarChar(50)
  ocrStatus         OcrStatus @default(pending) @map("ocr_status")
  ocrRawText        String?   @map("ocr_raw_text") @db.Text
  extractedMerchant String?   @map("extracted_merchant") @db.VarChar(255)
  extractedDate     DateTime? @map("extracted_date") @db.Date
  extractedTotal    Decimal?  @map("extracted_total") @db.Decimal(12, 2)
  ocrProcessedAt    DateTime? @map("ocr_processed_at") @db.Timestamptz
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  transaction Transaction?

  @@index([userId])
  @@index([ocrStatus])
  @@index([createdAt])
  @@map("receipts")
}

// 取引タイプ
enum TransactionType {
  expense
  income
  adjustment

  @@map("transaction_type")
}

// 取引
model Transaction {
  id              String          @id @default(uuid()) @db.Uuid
  userId          String          @map("user_id") @db.Uuid
  receiptId       String?         @unique @map("receipt_id") @db.Uuid
  type            TransactionType @default(expense)
  amount          Decimal         @db.Decimal(12, 2)
  transactionDate DateTime        @map("transaction_date") @db.Date
  merchant        String?         @db.VarChar(255)
  properties      Json            @default("{}")
  createdAt       DateTime        @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime        @updatedAt @map("updated_at") @db.Timestamptz

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  receipt Receipt? @relation(fields: [receiptId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([transactionDate])
  @@index([type])
  @@map("transactions")
}

// 請求サイクル
enum BillingCycle {
  monthly
  yearly

  @@map("billing_cycle")
}

// サブスクリプションステータス
enum SubscriptionStatus {
  active
  paused
  cancelled

  @@map("subscription_status")
}

// サブスクリプション
model Subscription {
  id              String             @id @default(uuid()) @db.Uuid
  userId          String             @map("user_id") @db.Uuid
  serviceName     String             @map("service_name") @db.VarChar(255)
  amount          Decimal            @db.Decimal(12, 2)
  billingCycle    BillingCycle       @default(monthly) @map("billing_cycle")
  nextPaymentDate DateTime           @map("next_payment_date") @db.Date
  category        String?            @db.VarChar(100)
  status          SubscriptionStatus @default(active)
  memo            String?            @db.Text
  createdAt       DateTime           @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime           @updatedAt @map("updated_at") @db.Timestamptz

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([nextPaymentDate])
  @@map("subscriptions")
}

// ビュータイプ
enum ViewType {
  list
  calendar

  @@map("view_type")
}

// ビュー設定
model View {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  name       String   @db.VarChar(100)
  viewType   ViewType @default(list) @map("view_type")
  filters    Json     @default("{}")
  sortConfig Json     @default("{\"field\": \"transaction_date\", \"order\": \"desc\"}") @map("sort_config")
  groupBy    String?  @map("group_by") @db.VarChar(50)
  isDefault  Boolean  @default(false) @map("is_default")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamptz

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("views")
}

// 通知タイプ
enum NotificationType {
  subscription_reminder
  system
  info

  @@map("notification_type")
}

// 通知
model Notification {
  id          String           @id @default(uuid()) @db.Uuid
  userId      String           @map("user_id") @db.Uuid
  type        NotificationType
  title       String           @db.VarChar(255)
  message     String?          @db.Text
  relatedId   String?          @map("related_id") @db.Uuid
  isRead      Boolean          @default(false) @map("is_read")
  scheduledAt DateTime?        @map("scheduled_at") @db.Timestamptz
  createdAt   DateTime         @default(now()) @map("created_at") @db.Timestamptz

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([scheduledAt])
  @@map("notifications")
}

// リフレッシュトークン
model RefreshToken {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  tokenHash  String   @unique @map("token_hash") @db.VarChar(255)
  deviceInfo String?  @map("device_info") @db.VarChar(255)
  expiresAt  DateTime @map("expires_at") @db.Timestamptz
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}
